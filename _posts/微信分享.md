---
title: 微信分享
date: 2017-11-23 18:44:20
categories: 实战笔记
---

# 相关文档
微信JS-SDK说明文档 ：
[https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421141115](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421141115)

定制微信，手机QQ，QQ空间APP内的分享内容：
[http://open.mobile.qq.com/api/component/share](http://open.mobile.qq.com/api/component/share)

微信分享官方常见问题及处理方法：
[http://blog.sina.com.cn/s/blog_6c969b4a0102w8h3.html](http://blog.sina.com.cn/s/blog_6c969b4a0102w8h3.html)

# 微信分享代码
```javascript
<input class="actitle" type="hidden" value="客户管理，用哇呀" />
<input class="actsummary" type="hidden" value="哇呀CRM，专注房抵领域的客户管理系统，助您高效管理客户和订单" />
<input class="actlink" type="hidden" value="http://image.wayaa.com/images/sharelogo.png" />
<input class="linkpage" type="hidden" value="" />
<input id="appId" name="appId" type="hidden" value="${appId}"/>
<input id="timestamp" name="timestamp" type="hidden" value="${timestamp}"/>
<input id="nonceStr" name="nonceStr" type="hidden" value="${nonceStr}"/>
<input id="signature" name="signature" type="hidden" value="${signature}"/>
<input type="hidden" id="customerId" value="${customerId}" />
<input type="hidden" id="token" value="${token}" />
<input type="hidden" id="channel" value="${channel}" />
<script src="${jscss_url}/js/myshare.js"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script> 
<script type="text/javascript" src="http://qzonestyle.gtimg.cn/qzone/qzact/common/share/share.js"></script>
/*myshare.js*/
$(function share() {
    var actitle = $(".actitle").val();//分享标题
    var actsummary = $(".actsummary").val();//分享内容
    var actlink = $(".actlink").val();//分享logo链接
    var linkpage = $(".linkpage").val();//分享页面链接（该分享连接域名必须与当前页面对应的公众号js安全域名一致）
    var appId = $("#appId").val();
    var timestamp = $("#timestamp").val();
    var nonceStr = $("#nonceStr").val();
    var signature = $("#signature").val();

//==>微信内的网页分享
    //通过config接口注入权限验证配置
    wx.config({
        debug: true,// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
        appId: appId,//必填，公众号唯一标识
        timestamp: timestamp,//必填，生成签名时间戳
        nonceStr: nonceStr,//必填，生成签名的随机串
        signature: signature,//必填，签名
        jsApiList: [
            "onMenuShareTimeline",//分享到朋友圈
            "onMenuShareAppMessage",//分享给朋友
            "onMenuShareQQ",//分享到QQ
            "onMenuShareWeibo",//分享到腾讯微博
            "onMenuShareQZone"//分享到QQ空间
        ]//必填，需要使用的JS接口列表
    });

    //通过ready接口处理成功验证
    wx.ready(function() {
        wx.onMenuShareTimeline({
            title: actitle,
            link: linkpage,
            imgUrl: actlink,
            success: function(e) {
                //用户确认分享后执行的回调函数
            },
            cancel: function(e) {
                //用户取消分享后执行的回调函数
            },
            fail: function(e){
                //用户分享失败后执行的回调函数
            },
            complete: function(e){
                //用户完成分享后执行的回调函数
            }
        });
        wx.onMenuShareAppMessage({
            title: actitle,
            desc: actsummary,
            link: linkpage,
            imgUrl: actlink,
            type: "",
            dataUrl: "",
            success: function(e) {},
            cancel: function(e) {}
        });
        wx.onMenuShareQQ({
            title: actitle,
            desc: actsummary,
            link: linkpage,
            imgUrl: actlink,
            success: function() {},
            cancel: function() {}
        });
        wx.onMenuShareWeibo({
            title: actitle,
            desc: actsummary,
            link: linkpage,
            imgUrl: actlink,
            success: function() {},
            cancel: function() {}
        });
        wx.onMenuShareQZone({
            title: actitle,
            desc: actsummary,
            link: linkpage,
            imgUrl: actlink,
            success: function() {},
            cancel: function() {}
        })
    });

    //通过error接口处理失败验证
    wx.error(function(res) {
        //config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
        alert(JSON.stringify(res.errMsg))
        //{"errMsg":"config:invalid url domain"}
    });

    //==>定制微信，手机QQ，QQ空间APP内的分享内容
    setShareInfo({//
        title: actitle,
        summary: actsummary,
        pic: actlink,
        url: linkpage,
        WXconfig: {//微信权限验证配置信息，若不在微信传播，可忽略
            swapTitleInWX: true,//是否标题内容互换（仅朋友圈，因朋友圈内只显示标题）
            appId: appId,
            timestamp: timestamp,
            nonceStr: nonceStr,
            signature: signature
        }
    });
});
```

# 注意事项
- 用了setShareInfo之后，wx.onMenuShareTimeline等等，无论分享成功还是失败都不执行回调，并且debug开启模式在手机上没有alert提示，只在pc有log信息
- 注释掉setShareInfo之后,开启debug模式，调用的所有api的返回值会在客户端alert出来
- 由于手机QQ限制，分享URL必须与页面URL同一域名，否则设置不生效。
- 可根据当前页面的客户端环境，判断是否需要WX配置，减少不必要请求。
- 图片大小要大于300pix才能显示；

# 分享失败的可能原因
wx.error排查

- 后台参数是否传了
- 分享id是否正确，有没有变动
- 分享文案是否有敏感词汇
- 分享域名是否与公众号功能设置的js安全域名一致，一个公众号绑定三个域名，否则重新申请公众号

